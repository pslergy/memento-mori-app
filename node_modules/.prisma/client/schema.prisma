// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// üë§ –ú–û–î–ï–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (USER)
// =============================================================================

model User {
  id       String @id @default(uuid())
  email    String @unique
  username String @unique

  // –ü–∞—Ä–æ–ª—å –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  passwordHash         String
  recoveryMnemonicHash String? // <-- üî• –î–û–ë–ê–í–õ–ï–ù–û: –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 12 —Å–ª–æ–≤

  countryCode String
  gender      Gender
  dateOfBirth DateTime
  deathDate   DateTime
  lifestyle   Json?

  createdAt DateTime @default(now())

  // –°–≤—è–∑–∏
  friendsAsA   Friendship[]      @relation("friendsAsUserA")
  friendsAsB   Friendship[]      @relation("friendsAsUserB")
  chatRooms    ChatParticipant[]
  sentMessages Message[]
  reportsMade  Report[]          @relation("ReportsMadeByUser")
  reportsAbout Report[]          @relation("ReportsAboutUser")
  isShadow     Boolean           @default(false)
}

// =============================================================================
// ü§ù –î–†–£–ñ–ë–ê (FRIENDSHIP)
// =============================================================================

model Friendship {

  userA_id String
  userB_id String
  userA    User   @relation("friendsAsUserA", fields: [userA_id], references: [id])
  userB    User   @relation("friendsAsUserB", fields: [userB_id], references: [id])

  status        FriendshipStatus @default(PENDING)
  requestedById String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userA_id, userB_id])
}

// =============================================================================
// üí¨ –ß–ê–¢–´ –ò –°–û–û–ë–©–ï–ù–ò–Ø
// =============================================================================

model ChatRoom {
  id          String   @id @default(uuid())
  type        ChatType @default(DIRECT)
  name        String?
  isEphemeral Boolean  @default(false)
  createdAt   DateTime @default(now())

  // üî• –î–û–ë–ê–í–õ–ï–ù–û: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤–µ—Ç–æ–∫ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  lastActivityAt DateTime @default(now())

  participants ChatParticipant[]
  messages     Message[]

  isPublic    Boolean @default(false)
  description String?
}

model ChatParticipant {

  userId     String
  chatRoomId String
  user       User     @relation(fields: [userId], references: [id])
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id])

  joinedAt DateTime @default(now())

  @@id([userId, chatRoomId])
}

model Message {
  id          String        @id @default(uuid())
  content     String
  createdAt   DateTime      @default(now())
  senderId    String
  chatRoomId  String
  expiresAt   DateTime?
  status      MessageStatus @default(SENT)
  isEncrypted Boolean       @default(false)

  sender   User     @relation(fields: [senderId], references: [id])
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
}

// =============================================================================
// üö® –ñ–ê–õ–û–ë–´ (REPORTS)
// =============================================================================

model Report {
  id          String       @id @default(uuid())
  reason      String
  description String?
  status      ReportStatus @default(PENDING)

  reporterUserId String
  reportedUserId String
  messageId      String?

  reporterUser User @relation("ReportsMadeByUser", fields: [reporterUserId], references: [id])
  reportedUser User @relation("ReportsAboutUser", fields: [reportedUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// üìã ENUMS (–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏)
// =============================================================================

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum ChatType {
  DIRECT
  GROUP
  CHANNEL
  GLOBAL
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum ReportStatus {
  PENDING
  RESOLVED
  REJECTED
}
